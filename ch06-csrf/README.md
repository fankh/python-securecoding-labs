# Chapter 06: CSRF (Cross-Site Request Forgery) ì‹¤ìŠµ

## í•™ìŠµ ëª©í‘œ
- CSRF ê³µê²©ì˜ ì›ë¦¬ì™€ ìœ„í—˜ì„± ì´í•´
- CSRF í† í°ì„ ì´ìš©í•œ ë°©ì–´ êµ¬í˜„
- SameSite ì¿ í‚¤ ì„¤ì • ë°©ë²• ìŠµë“

## CSRFë€?

CSRF(Cross-Site Request Forgery)ëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ëœ ìƒíƒœì—ì„œ, ê³µê²©ìê°€ ë§Œë“  ì•…ì„± ì›¹í˜ì´ì§€ë¥¼ ë°©ë¬¸í•˜ë©´
ì‚¬ìš©ìì˜ ì˜ë„ì™€ ë¬´ê´€í•˜ê²Œ ìš”ì²­ì´ ì „ì†¡ë˜ëŠ” ê³µê²©ì…ë‹ˆë‹¤.

**í•µì‹¬ ì›ë¦¬:** ë¸Œë¼ìš°ì €ëŠ” ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ í¬í•¨í•˜ì—¬ ìš”ì²­ì„ ì „ì†¡í•˜ë¯€ë¡œ,
ë¡œê·¸ì¸ ìƒíƒœì˜ ì‚¬ìš©ìê°€ ê³µê²© í˜ì´ì§€ë¥¼ ë°©ë¬¸í•˜ë©´ ì¸ì¦ëœ ìš”ì²­ì´ ìë™ ì‹¤í–‰ë©ë‹ˆë‹¤.

## ì‹¤ìŠµ í™˜ê²½

```bash
cd ch06-csrf
docker-compose up -d

# ì·¨ì•½í•œ ë²„ì „: http://localhost:5001
# ì•ˆì „í•œ ë²„ì „: http://localhost:5002
# ê³µê²©ì ì„œë²„:  http://localhost:9000/attacker.html
```

**ì„œë¹„ìŠ¤ êµ¬ì„±:**
| ì„œë¹„ìŠ¤ | í¬íŠ¸ | ì„¤ëª… |
|--------|------|------|
| vulnerable | 5001 | CSRF ì·¨ì•½í•œ ì€í–‰ ì„œë¹„ìŠ¤ |
| secure | 5002 | CSRF ë°©ì–´ê°€ ì ìš©ëœ ì€í–‰ ì„œë¹„ìŠ¤ |
| attacker | 9000 | ê³µê²©ìì˜ ì•…ì„± ì›¹ì„œë²„ (attacker.html í˜¸ìŠ¤íŒ…) |

**í…ŒìŠ¤íŠ¸ ê³„ì •:**
| ì‚¬ìš©ì | ì´ˆê¸° ì”ì•¡ |
|--------|----------|
| `alice` | 1,000ì› |
| `bob` | 1,000ì› |

> ë¡œê·¸ì¸ ì‹œ Usernameë§Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤ (ë¹„ë°€ë²ˆí˜¸ ì—†ìŒ)

## ì·¨ì•½ì  ë¹„êµ

| í•­ëª© | ì·¨ì•½í•œ ë²„ì „ (5001) | ì•ˆì „í•œ ë²„ì „ (5002) |
|------|-------------------|-------------------|
| CSRF í† í° | ì—†ìŒ | Flask-WTF ìë™ ê²€ì¦ |
| ì†¡ê¸ˆ HTTP ë©”ì„œë“œ | GET + POST ëª¨ë‘ í—ˆìš© | POSTë§Œ í—ˆìš© |
| SameSite ì¿ í‚¤ | `SameSite=None` (ëª¨ë“  ì‚¬ì´íŠ¸ í—ˆìš©) | `SameSite=Strict` |
| secret_key | í•˜ë“œì½”ë”© (`"secret"`) | `os.urandom(32)` |

## ê³µê²© ì‹¤ìŠµ (ì·¨ì•½í•œ ë²„ì „)

### ë‹¨ê³„ 1: í”¼í•´ì(alice) ë¡œê·¸ì¸

1. ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5001 ì ‘ì†
2. Usernameì— `alice` ì…ë ¥ í›„ Login í´ë¦­
3. ì”ì•¡ 1,000ì› í™•ì¸

### ë‹¨ê³„ 2: ê³µê²© í˜ì´ì§€ ì—´ê¸°

`docker-compose up -d` ì‹¤í–‰ ì‹œ ê³µê²©ì ì„œë²„(port 9000)ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.

**ì¤‘ìš”:** `attacker.html`ì„ ë¡œì»¬ íŒŒì¼(`file://`)ë¡œ ì—´ë©´ **ì¿ í‚¤ê°€ ì „ì†¡ë˜ì§€ ì•Šì•„ ê³µê²©ì´ ì‹¤íŒ¨**í•©ë‹ˆë‹¤.
ë°˜ë“œì‹œ HTTP ì„œë²„ë¥¼ í†µí•´ ì ‘ì†í•´ì•¼ í•©ë‹ˆë‹¤.

### ë‹¨ê³„ 3: ê³µê²© ì‹¤í–‰

1. aliceê°€ ë¡œê·¸ì¸ëœ **ë™ì¼í•œ ë¸Œë¼ìš°ì €**ì—ì„œ http://localhost:9000/attacker.html ì„ ì—½ë‹ˆë‹¤
2. "ê²½í’ˆ ìˆ˜ë ¹í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤ (ìˆ¨ê²¨ì§„ ì†¡ê¸ˆ í¼ì´ ì œì¶œë¨)
3. http://localhost:5001 ë¡œ ëŒì•„ê°€ì„œ ì”ì•¡ì„ í™•ì¸í•©ë‹ˆë‹¤
4. **aliceì˜ ì”ì•¡ì´ 1,000ì› â†’ 500ì›ìœ¼ë¡œ ê°ì†Œ** (ê³µê²© ì„±ê³µ)

> **ì°¸ê³ :** ì·¨ì•½í•œ ë²„ì „ì€ `SameSite=None` ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œë„ ì¿ í‚¤ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
> Chromeì—ì„œ ë™ì‘í•˜ì§€ ì•Šìœ¼ë©´ Firefoxë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (`SameSite=None` + HTTPëŠ” Firefoxì—ì„œ ë” ì˜ ë™ì‘í•©ë‹ˆë‹¤).

### ê³µê²©ì´ ì„±ê³µí•˜ëŠ” ì´ìœ 

```
[aliceì˜ ë¸Œë¼ìš°ì €]
    â†“ ë¡œê·¸ì¸ â†’ ì„¸ì…˜ ì¿ í‚¤ ì €ì¥ë¨
    â†“
[ê³µê²©ì í˜ì´ì§€ ë°©ë¬¸]
    â†“ ìˆ¨ê²¨ì§„ í¼ ìë™ ì œì¶œ
    â†“ ë¸Œë¼ìš°ì €ê°€ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ìë™ í¬í•¨!
    â†“
[ì„œë²„: localhost:5001/transfer]
    â†“ ìœ íš¨í•œ ì„¸ì…˜ ì¿ í‚¤ í™•ì¸ â†’ aliceì˜ ìš”ì²­ìœ¼ë¡œ ì¸ì‹
    â†“ CSRF í† í° ê²€ì¦ ì—†ìŒ â†’ ì†¡ê¸ˆ ì‹¤í–‰
    â†“
[ê²°ê³¼: alice â†’ attackerì—ê²Œ 500ì› ì†¡ê¸ˆ]
```

### GET ìš”ì²­ì„ ì´ìš©í•œ ê³µê²© (ì´ë¯¸ì§€ íƒœê·¸)

ì·¨ì•½í•œ ë²„ì „ì€ GET ìš”ì²­ë„ í—ˆìš©í•˜ë¯€ë¡œ, ì´ë¯¸ì§€ íƒœê·¸ë§Œìœ¼ë¡œë„ ê³µê²© ê°€ëŠ¥í•©ë‹ˆë‹¤:

```html
<!-- í”¼í•´ìê°€ ì´ ì´ë¯¸ì§€ê°€ í¬í•¨ëœ í˜ì´ì§€ë¥¼ ë°©ë¬¸í•˜ë©´ ìë™ ì†¡ê¸ˆë¨ -->
<img src="http://localhost:5001/transfer?to=attacker&amount=500" width="0" height="0">
```

## ë°©ì–´ í™•ì¸ (ì•ˆì „í•œ ë²„ì „)

### ì•ˆì „í•œ ë²„ì „ì—ì„œ ë™ì¼í•œ ê³µê²© ì‹œë„

1. ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5002 ì ‘ì†
2. `alice`ë¡œ ë¡œê·¸ì¸
3. `attacker.html`ì˜ í¬íŠ¸ë¥¼ 5002ë¡œ ë³€ê²½í•œ ë²„ì „ì„ ë§Œë“¤ì–´ì„œ ê³µê²© ì‹œë„
4. **400 Bad Request ì—ëŸ¬ ë°œìƒ** â€” CSRF í† í°ì´ ì—†ìœ¼ë¯€ë¡œ ìš”ì²­ ê±°ë¶€
5. ì¶”ê°€ë¡œ `SameSite=Strict` ì¿ í‚¤ì´ë¯€ë¡œ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ì„œ ì¿ í‚¤ ìì²´ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ

### curlë¡œ CSRF ë°©ì–´ í™•ì¸

```bash
# CSRF í† í° ì—†ì´ ì†¡ê¸ˆ ìš”ì²­ â†’ 400 ì—ëŸ¬ (ë°©ì–´ ì„±ê³µ)
curl.exe -X POST http://localhost:5002/transfer \
  -d "to=attacker&amount=100"
```

## ë°©ì–´ ê¸°ë²•

### 1. Flask-WTF CSRF ë³´í˜¸

```python
from flask_wtf import CSRFProtect

app = Flask(__name__)
csrf = CSRFProtect(app)
```

### 2. í…œí”Œë¦¿ì— CSRF í† í° ì¶”ê°€

```html
<form action="/transfer" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input name="to" placeholder="ë°›ëŠ” ì‚¬ëŒ">
    <input name="amount" type="number" placeholder="ê¸ˆì•¡">
    <button type="submit">ì†¡ê¸ˆ</button>
</form>
```

### 3. POST ìš”ì²­ë§Œ í—ˆìš©

```python
# ì·¨ì•½: GET + POST ëª¨ë‘ í—ˆìš©
@app.route("/transfer", methods=["GET", "POST"])

# ì•ˆì „: POSTë§Œ í—ˆìš©
@app.route("/transfer", methods=["POST"])
```

### 4. SameSite ì¿ í‚¤ ì„¤ì •

```python
@app.after_request
def set_cookie_options(response):
    existing_cookie = response.headers.get('Set-Cookie', '')
    if existing_cookie:
        response.headers['Set-Cookie'] = existing_cookie + '; SameSite=Strict'
    return response
```

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. pytest ì‹¤í–‰

```bash
cd ch06-csrf
python -m pytest test_app.py -v
```

**ì˜ˆìƒ ì¶œë ¥:**
```
test_app.py::TestVulnerableApp::test_index PASSED                    [ 50%]
test_app.py::TestSecureApp::test_index PASSED                        [100%]

============================== 2 passed in 0.35s ==============================
```

**ì°¸ê³ :**
- CSRF ê³µê²©ì€ ë¸Œë¼ìš°ì € ì„¸ì…˜(ì¿ í‚¤ ìë™ ì „ì†¡)ì„ ì´ìš©í•˜ë¯€ë¡œ, pytestë¡œëŠ” ì™„ì „í•œ í…ŒìŠ¤íŠ¸ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤
- ì‹¤ì œ ê³µê²© í…ŒìŠ¤íŠ¸ëŠ” ìœ„ì˜ **ê³µê²© ì‹¤ìŠµ** ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”

**ê°œë³„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰:**
```bash
# ì·¨ì•½í•œ ë²„ì „ë§Œ í…ŒìŠ¤íŠ¸
python -m pytest test_app.py::TestVulnerableApp -v

# ì•ˆì „í•œ ë²„ì „ë§Œ í…ŒìŠ¤íŠ¸
python -m pytest test_app.py::TestSecureApp -v
```

### 2. Bandit ì •ì  ë¶„ì„

```bash
cd ch06-csrf

# ìë™ ìŠ¤ìº” (ì·¨ì•½í•œ ì½”ë“œ vs ì•ˆì „í•œ ì½”ë“œ ë¹„êµ)
bash test_bandit.sh

# ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰
python -m bandit -r vulnerable/ -ll
python -m bandit -r secure/ -ll
```

**ì˜ˆìƒ ê²°ê³¼:**
| ì½”ë“œ | Bandit ê²°ê³¼ |
|------|------------|
| `vulnerable/app.py` | ğŸ”´ B105: í•˜ë“œì½”ë”©ëœ secret_key<br>ğŸ”´ B201: debug=True í™œì„±í™” |
| `secure/app.py` | âš ï¸ B105: secret_key (í™˜ê²½ë³€ìˆ˜ ê¶Œì¥)<br>âœ… debug=False |

### 3. ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (ë¸Œë¼ìš°ì €)

#### ì·¨ì•½í•œ ë²„ì „ í…ŒìŠ¤íŠ¸
1. http://localhost:5001 ì ‘ì† â†’ `alice`ë¡œ ë¡œê·¸ì¸
2. ì”ì•¡ 1,000ì› í™•ì¸
3. **ë™ì¼ ë¸Œë¼ìš°ì €**ì—ì„œ http://localhost:9000/attacker.html ì ‘ì†
4. "ê²½í’ˆ ìˆ˜ë ¹í•˜ê¸°" í´ë¦­ â†’ ì”ì•¡ 500ì›ìœ¼ë¡œ ê°ì†Œ í™•ì¸ (ê³µê²© ì„±ê³µ)

#### ì•ˆì „í•œ ë²„ì „ í…ŒìŠ¤íŠ¸
1. http://localhost:5002 ì ‘ì† â†’ `alice`ë¡œ ë¡œê·¸ì¸
2. ì”ì•¡ 1,000ì› í™•ì¸
3. ê³µê²© í˜ì´ì§€ì—ì„œ í¬íŠ¸ë¥¼ 5002ë¡œ ë³€ê²½í•˜ì—¬ ê³µê²© ì‹œë„
4. 400 ì—ëŸ¬ ë°œìƒ í™•ì¸ (ë°©ì–´ ì„±ê³µ)
5. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) â†’ ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ CSRF í† í°ì´ í¼ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

## ë³´ì•ˆ ìŠ¤ìºë‹

### Bandit ì·¨ì•½ì  ê²€ì¶œ
```bash
# ì „ì²´ ìŠ¤ìº”
python -m bandit -r . -ll

# íŠ¹ì • íŒŒì¼ ìŠ¤ìº”
python -m bandit vulnerable/app.py

# JSON ì¶œë ¥
python -m bandit -r vulnerable/ -f json -o bandit-report.json
```

**ê²€ì¶œë˜ëŠ” ì·¨ì•½ì :**
- **B105 (LOW)**: Hardcoded password string (secret_key)
- **B201 (HIGH)**: Flask app with debug=True

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  ìƒíƒœ ë³€ê²½ ìš”ì²­ì— CSRF í† í° ì ìš©
- [ ] POST ìš”ì²­ë§Œ í—ˆìš© (GETìœ¼ë¡œ ìƒíƒœ ë³€ê²½ ê¸ˆì§€)
- [ ] SameSite=Strict ì¿ í‚¤ ì„¤ì •
- [ ] secret_keyë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
- [ ] debug=False ì„¤ì • (í”„ë¡œë•ì…˜)
- [ ] Bandit ì •ì  ë¶„ì„ í†µê³¼
